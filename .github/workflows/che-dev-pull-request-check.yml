#
# Copyright (c) 2021 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#

name: che-dev Pull Request Check

# Trigger the workflow on pull request
on: [pull_request]

jobs:

  dev1:
    name: dev1
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout che-code source code
        uses: actions/checkout@v3

      - name: Cleanup docker images
        run: |
          docker system prune -af

      - name: Build Che-Code Docker image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --progress=plain \
            -f build/dockerfiles/dev.Dockerfile \
            -t che-dev-am64 .

      - name: Display docker images
        run: |
          echo "================================================================="
          docker images
          echo "================================================================="

      - name: Compress che-dev image to a file
        run: |
          docker save che-dev-am64 | gzip > che-dev-am64.tgz

      - name: Upload che-dev docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: che-dev-image
          path: che-dev-am64.tgz

  dev2:
    name: dev2
    runs-on: ubuntu-22.04
    needs: dev1
    steps:

      - name: Cleanup docker images
        run: |
          docker system prune -af

      - name: Download che-dev docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: che-dev-image
          path: .

      - name: Load dev Docker image
        run: |
          docker load -i che-dev-am64.tgz

      - name: Display docker images
        run: |
          echo "================================================================="
          docker images
          echo "================================================================="

      - name: Login to Quay.io
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_PULL_REQUESTS_USERNAME }}
          password: ${{ secrets.QUAY_PULL_REQUESTS_PASSWORD }}

      - name: Publish che-dev image
        run: |
          PR_NUMBER="${{ github.event.number }}"
          echo "Pull request ${PR_NUMBER}"

          DEV_IMAGE_NAME="quay.io/vgulyy/che-code-dev:pr-${PR_NUMBER}-dev-amd64"
          # DEV_IMAGE_NAME="quay.io/che-incubator-pull-requests/che-code-dev:pr-${PR_NUMBER}-dev-amd64"
          echo "Dev image ${DEV_IMAGE_NAME}"
          echo "_DEV_IMAGE_NAME=${DEV_IMAGE_NAME}" >> $GITHUB_ENV

          docker tag che-dev-am64 ${DEV_IMAGE_NAME}
          docker push ${DEV_IMAGE_NAME}

      - name: 'Comment PR'
        uses: actions/github-script@v6
        with:
         script: |
           const { repo: { owner, repo } } = context;
           await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Pull Request Dev image published:\nðŸ‘‰ [${process.env._DEV_IMAGE_NAME}](https://${process.env._DEV_IMAGE_NAME})`
            })
