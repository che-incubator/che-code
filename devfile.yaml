#
# Copyright (c) 2022-2024 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#

schemaVersion: 2.2.2
metadata:
  name: che-code
components:

  - name: dev
    container:
      image: quay.io/che-incubator/che-code-dev:insiders
      memoryLimit: 12Gi
      memoryRequest: 512Mi
      cpuRequest: 500m
      cpuLimit: 3500m
      endpoints:
        - exposure: public
          name: dev
          secure: true
          protocol: http
          targetPort: 8000
      env:
        - name: KUBEDOCK_ENABLED
          value: "true"

  - name: projects
    volume:
      size: 10Gi

commands:
  - id: install-dependencies
    exec:
      label: Install node dependencies
      component: dev
      workingDir: ${PROJECTS_ROOT}/che-code
      commandLine: |
        npm install
      group:
        kind: build

  - id: build-application
    exec:
      label: Compile with npm
      component: dev
      workingDir: ${PROJECTS_ROOT}/che-code
      commandLine: |
        npm run watch
      group:
        kind: build
        isDefault: true

  - id: run-application
    exec:
      label: Run VS Code server on port 8000
      component: dev
      workingDir: ${PROJECTS_ROOT}/che-code
      commandLine: |
        npm run server
      group:
        kind: run
        isDefault: true

  - id: print-project-source
    exec:
      label: "Print PROJECT_SOURCE"
      component: dev
      commandLine: |
        echo "PROJECT_SOURCE = ${PROJECT_SOURCE}"

  - id: node-version
    exec:
      label: "Check Node.js version"
      component: dev
      commandLine: "node -v"

  - id: npm-version
    exec:
      label: "Check npm version"
      component: dev
      commandLine: "npm -v"

  - id: npm-version-node-version
    composite:
      label: "Sequential: Check versions"
      commands:
        - print-project-source
        - npm-version
        - node-version
      parallel: false

  - id: check-versions-install-deps
    composite:
      label: "Check versions => Install deps"
      commands:
        - npm-version-node-version
        - install-dependencies
      parallel: false

  - id: parallel-check-versions
    composite:
      label: "Parallel: Check versions"
      commands:
        - print-project-source
        - npm-version
        - node-version
      parallel: true

  - id: install-deps-and-run-app
    composite:
      label: "Install deps => Build app => Run web app"
      commands:
        - install-dependencies
        - build-application
        - run-application
      parallel: false

  - id: parallel-install-deps-and-run-app
    composite:
      label: "Parallel: Install deps, build app and Run web app"
      commands:
        - install-dependencies
        - build-application
        - run-application
      parallel: true

  - id: check-node-and-install-deps-and-run-app
    composite:
      label: "Check Node.js version => Install deps => Run web app"
      commands:
        - node-version
        - install-dependencies
        - run-application
      parallel: false

  - id: check-versions-install-deps-run-app
    composite:
      label: "Check versions => Install deps => Run web app"
      commands:
        - check-versions-install-deps
        - run-application
      parallel: false

  - id: print-env-variables-check-versions
    composite:
      label: "Print Env variables => Check versions"
      commands:
        - print-env-variables
        - npm-version-node-version
      parallel: false
  - id: parallel-print-env-variables-check-versions
    composite:
      label: "Parallel: Print Env variables => Check versions"
      commands:
        - print-env-variables
        - npm-version-node-version
      parallel: true
